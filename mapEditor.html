<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Game Editor</title>
  <link rel="stylesheet" href="./css/editor.css" />
</head>
<body>
  <!-- Sidebar / Tileset picker -->
  <aside id="sidebar">
    <h3>Tileset &amp; Picker</h3>
    <div id="pickerPanel">
      <div class="ctrl">
        <label for="tilesetSelect">Tileset</label>
        <select id="tilesetSelect" title="Wybierz PNG tilesetu"></select>
      </div>

      <div class="ctrl">
        <label for="tileSize">Tile</label>
        <input type="number" id="tileSize" min="4" max="128" step="1" value="32" style="width:72px" />
        <span class="mini">px</span>
      </div>

      <div id="pickedTilePreview" class="ctrl">
        <canvas id="pickedTileCanvas" width="64" height="64"></canvas>
        <div class="grid" style="gap:2px">
          <div class="mini">Cur. tile: <span id="pickedLabel">(0,0)</span></div>
          <div class="mini">Type (B): <span id="pickedTypeLabel">ground (0)</span></div>
          <div class="mini">Flags (A): <span id="pickedFlagsLabel">0b0000</span></div>
        </div>
      </div>

      <div id="pickerScroll">
        <canvas id="pickerCanvas"></canvas>
      </div>

      <div class="hint">
        LMB: draw, RMB: select. ALT: probe.
        Layer <b>Scripts</b>: LMB dodaje/zaznacza, <b>Delete usuwa</b>, dwuklik otwiera edytor.
      </div>
    </div>

    <h3>Project / Maps</h3>
    <div id="projectPanel" style="padding:10px; display:grid; gap:8px;">
      <div class="ctrl">
        <button id="newMapBtn" class="ghost">+ New Map</button>
        <button id="delMapBtn" class="danger">Delete Map</button>
        <button id="renameMapBtn" class="ghost">Rename</button>
      </div>

      <div class="ctrl">
        <button id="saveProjectBtn" class="primary">SAVE PROJECT</button>
        <label class="btn btn--ghost" style="padding:0;">
          <input id="loadProjectInput" type="file" accept="application/json" />
        </label>
      </div>

      <!-- Listbox z mapami -->
      <div class="ctrl" style="display:block;">
        <ul id="mapsList" style="list-style:none; margin:0; padding:0; display:grid; gap:6px;"></ul>
      </div>
    </div>
  </aside>

  <!-- Toolbar -->
  <header id="toolbar">
    <div class="ctrl" style="grid-column: span 3;">
      <label for="mapName">Map</label>
      <input id="mapName" type="text" placeholder="mapa_01" value="mapa_01" />
    </div>

    <div class="ctrl" style="grid-column: span 4;">
      <label>Layer</label>
      <label class="flex"><input type="radio" name="layer" value="ground" checked> Ground</label>
      <label class="flex"><input type="radio" name="layer" value="details"> Details</label>
      <label class="flex"><input type="radio" name="layer" value="details2"> Details2</label>
      <label class="flex"><input type="radio" name="layer" value="ceiling"> Ceiling</label>
      <label class="flex"><input type="radio" name="layer" value="ceiling2"> Ceiling2</label>
      <label class="flex"><input type="radio" name="layer" value="scripts"> Scripts</label>
    </div>

    <div class="ctrl" style="grid-column: span 2;">
      <label class="flex"><input type="checkbox" id="ghostOther" checked> Show other</label>
      <label class="flex"><input type="checkbox" id="showGrid" checked> Grid</label>
    </div>

    <div class="ctrl" style="grid-column: span 3;">
      <label for="typeSelect">Typ (B)</label>
      <select id="typeSelect"></select>
      <span class="mini">Ceiling* wymusza B=0</span>
    </div>

    <div class="ctrl" style="grid-column: span 3;">
      <label>Flagi (A)</label>
      <label class="flex"><input type="checkbox" id="flagFlipX"> FlipX</label>
      <label class="flex"><input type="checkbox" id="flagFlipY"> FlipY</label>
      <label class="flex"><input type="checkbox" id="flagRot90"> Rot90°</label>
    </div>

    <div class="ctrl" style="grid-column: span 3;">
      <label for="mapW">W</label>
      <input id="mapW" type="number" value="32" min="1" max="1024" style="width:72px" />
      <label for="mapH">H</label>
      <input id="mapH" type="number" value="18" min="1" max="1024" style="width:72px" />
      <button id="applySize" class="ghost">Apply size</button>
    </div>

    <div class="ctrl" style="grid-column: span 2;">
      <label for="zoomRange">Zoom</label>
      <input id="zoomRange" type="range" min="1" max="5" step="1" value="1" />
      <span id="zoomLabel" class="mini">x1</span>
    </div>

    <div class="ctrl" style="grid-column: span 4;">
      <button id="saveJsonBtn" class="primary">SAVE JSON</button>
      <input id="loadJsonInput" type="file" accept="application/json" />
      <button id="clearLayerBtn" class="danger">Clear layer</button>
    </div>

    <div class="ctrl" style="grid-column: span 4;">
      <label>Tools</label>
      <label class="flex"><input type="radio" name="tool" value="pencil" checked> Pencil</label>
      <label class="flex"><input type="radio" name="tool" value="line"> Line</label>
      <label class="flex"><input type="radio" name="tool" value="rect"> Rect</label>
      <label class="flex"><input type="radio" name="tool" value="circle"> Circle</label>
      <label class="flex" id="fillWrap"><input type="checkbox" id="fillShape" checked> Fill</label>
    </div>

    <div class="ctrl" style="grid-column: span 2;">
      <button id="undoBtn" class="ghost" disabled>Undo (Ctrl+Z)</button>
      <button id="redoBtn" class="ghost" disabled>Redo (Ctrl+Y / Shift+Ctrl+Z)</button>
    </div>

    <!-- Script tools (visible only on Scripts layer) -->
    <div id="scriptTools" class="ctrl" style="grid-column: 1 / -1; display:none;">
      <strong>Scripts:</strong>
      <label for="scriptProps">Props (JSON)</label>
      <input id="scriptProps" type="text" placeholder='{"note":"..."}' style="min-width:320px" />
      <button id="openScriptEditorBtn" class="ghost">Open editor</button>
      <span class="hint">LPM: dodaj/zaznacz • ALT+klik: pipeta • <b>Delete</b>: usuń • Dwuklik: edytor.</span>
    </div>
  </header>

  <!-- Main / Canvas -->
  <main id="main">
    <div id="canvasWrap">
      <canvas id="mapCanvas" width="512" height="512"></canvas>
    </div>
    <div id="statusBar">
      <div>Pos: <span id="posLabel">-,-</span> | Tile: <span id="tileLabel">-,-</span></div>
      <div>Layer: <span id="layerLabel">ground</span> | Tileset: <span id="tilesetName">(brak)</span></div>
      <div>MB1: draw | MB2: delete | <span class="hint">Alt: probe</span></div>
    </div>
  </main>

  <!-- ================= Script Overlay (RPGMaker-like) ================= -->
  <div id="scriptOverlay" aria-hidden="true">
    <div class="ov" role="dialog" aria-modal="true" aria-labelledby="ovTitle">
      <div class="ov__header">
        <div class="ov__title" id="ovTitle">Script Editor</div>
        <div class="ov__actions">
          <button id="scriptOvSave" class="btn btn--accent">Save</button>
          <button id="scriptOvClose" class="btn">Close</button>
        </div>
      </div>

      <div class="ov__body">
        <!-- LEFT: Sprite Picker -->
        <section class="panel spritePicker">
          <h4>Sprite</h4>
          <div class="preview">
            <canvas id="spritePreview" width="96" height="96"></canvas>
            <div class="grid">
              <div class="row">
                <label>Use sprite</label>
                <div class="toggle" id="spriteUseToggle" role="switch" aria-checked="false" tabindex="0"></div>
              </div>
              <div class="row">
                <label for="spriteSheetSelect">Sprite sheet</label>
                <select id="spriteSheetSelect"></select>
              </div>
              <div class="row">
                <label>Frame (x,y)</label>
                <div class="flex">
                  <input type="number" id="spriteFrameX" min="0" value="0" style="width:80px" />
                  <input type="number" id="spriteFrameY" min="0" value="0" style="width:80px" />
                </div>
              </div>
              <div class="row">
                <label for="spriteAnimSpeed">Anim speed</label>
                <input type="number" id="spriteAnimSpeed" min="0" step="1" value="8" />
              </div>
              <div class="row">
                <label for="spriteDir">Direction</label>
                <select id="spriteDir">
                  <option value="down">down</option>
                  <option value="left">left</option>
                  <option value="right">right</option>
                  <option value="up">up</option>
                </select>
              </div>
              <div class="row">
                <label>Loop</label>
                <label class="flex"><input type="checkbox" id="spriteLoop" checked> yes</label>
              </div>
            </div>
          </div>
          <div class="grid">
            <div class="subtle">Select tile – click to set start frame.</div>
            <div class="grid">
              <div class="grid spritePicker grid">
                <div class="grid" id="spriteGrid">
                  <!-- thumbs filled by JS -->
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- MIDDLE: Actions Flow -->
        <section class="panel flow">
          <div class="flow__toolbar">
            <div class="flow__add">
              <label for="actionAddSel" class="mini">Add action</label>
              <select id="actionAddSel">
                <option value="move">Move</option>
                <option value="dialog">Dialogue box</option>
                <option value="sleep">Sleep (waiting)</option>
                <option value="battle">Start battle</option>
                <option value="jump">Jump animation</option>
                <option value="inventory">Add/Remove item</option>
              </select>
              <button id="actionAddBtn" class="btn btn--accent">Add</button>
            </div>
            <div class="flex">
              <button id="actionCollapseAll" class="btn">Hide all</button>
              <button id="actionExpandAll" class="btn">Show all</button>
              <button id="actionClear" class="btn btn--danger">Clear</button>
            </div>
          </div>

          <div class="flow__list" id="flowList">
            <!-- items generated by JS -->
          </div>
        </section>

        <!-- RIGHT: Variables -->
        <section class="panel vars">
          <h4>Variables</h4>
          <div class="vars__toolbar">
            <input type="text" id="varsSearch" placeholder="Szukaj po nazwie lub ID…" />
            <select id="varsTypeFilter">
              <option value="">All types</option>
              <option value="int">int</option>
              <option value="bool">bool</option>
              <option value="float">float</option>
              <option value="enum">enum</option>
              <option value="enum_flags">enum (flags)</option>
            </select>
            <button id="varsResetFilter" class="btn">Reset</button>
            <button id="varsAddBtn" class="btn">Add variable</button>
            <button id="varsExportBtn" class="btn btn--accent">Export JSON</button>
            <label class="btn btn--ghost">
              Import JSON
              <input id="varsImportInput" type="file" accept="application/json" class="visually-hidden" />
            </label>
          </div>
          <div id="varsTableWrap">
            <table class="vars" aria-describedby="varsMeta">
              <thead>
                <tr>
                  <th style="width:72px;">ID</th>
                  <th class="vars__name">Name</th>
                  <th class="vars__type">Type</th>
                  <th>Enum values / Flags</th>
                  <th style="width:140px;">Default</th>
                </tr>
              </thead>
              <tbody id="varsTableBody">
                <!-- rows populated by JS -->
              </tbody>
            </table>
          </div>
          <div id="varsMeta" class="vars__meta">Source: <code>./assets/variables.json</code> — if none, a thousand will generate with names „Variable 1..1000”.</div>
        </section>
      </div>
    </div>
  </div>

  <!-- Templates -->
  <template id="tplActionItem">
    <div class="flow__item" data-action="">
      <div class="flow__head">
        <div class="flow__title">
          <span class="dragHandle" title="Przeciągnij do zmiany kolejności"><i class="icon drag"></i></span>
          <span class="badge" data-step>1</span>
          <span class="label">Action</span>
        </div>
        <div class="flow__controls">
          <button class="btn btn--ghost btn-collapse"><i class="icon caret"></i></button>
          <button class="btn btn--ghost btn-dup" title="Duplikuj"><i class="icon dup"></i></button>
          <button class="btn btn--danger btn-del" title="Usuń"><i class="icon delete"></i></button>
        </div>
      </div>
      <div class="flow__body">
        <!-- dynamic fields per action -->
      </div>
    </div>
  </template>

  <!-- Optional generic modal + toast -->
  <div class="modal" id="genericModal" aria-hidden="true">
    <div class="modal__panel">
      <div class="grid" id="genericModalBody"></div>
    </div>
  </div>
  <div class="toast hidden" id="toast"></div>

  <!-- Engine -->
  <script src="./engine/editor.js"></script>
</body>
</html>
